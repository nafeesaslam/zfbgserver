'use strict';function Oc(a,b){this.g=a;this.i=b;this.B=0;this.s=[];this.F=[];this.currentTime=this.h=0}function Pc(a){a.currentTime=Date.now()/1E3-a.h}function Qc(a,b){this.g=a;this.h=b}var Rc=0,Sc=[];function Tc(a){var b=Uc(!0);this.i=a;this.h=b;this.g=Vc(b,25,25);this.F=[]}function Wc(a){let b=a.h.g;Pc(b);b.B=a.g.v;b.F.length=0;var c=a.F,e=b.F;0<c.length&&(e.push.apply(e,c),c.length=0);a.i.emit("update",b)}
function Xc(){this.j=Rc++;this.l=1E4*Math.random()|0;this.C=1;this.i=[];this.h=new qa(this.l);this.g=new Oc(this.j,this.l);this.m=0;if(0!==this.j){for(var a=0;19>a;a++){var b=Vc(this,-400+800*(ma(this.h.g)/2147483647),-400+800*(ma(this.h.g)/2147483647));b.name=ea();b.N=!0}a=ua(this.h,6,40,.5);for(b=0;b<a.length;b++)Yc(this,6,a[b].x,a[b].y,a[b].z);a=ua(this.h,7,40,.5);for(b=0;b<a.length;b++)Yc(this,7,a[b].x,a[b].y,a[b].z)}}
function Yc(a,b,c,e,d,f,h,g){b=new fa(b,c,e,d,f,h,g);b.v=a.C++;a.g.s.push(b);return b}function Vc(a,b,c){a=Yc(a,2,b,n(a.h,b,c)+1,c);a.D=30;a.u=0;a.j=0;a.m=0;return a}function Zc(a,b){var c=a.i;c.splice(c.indexOf(b),1);a=a.g.s;a.splice(a.indexOf(b.g),1)}function cd(a,b){for(let c=0;c<a.i.length;c++)a.i[c].F.push(b)}
function gd(a,b,c,e,d){if(!(0>=b.D||0>=b.o)){var f=Math.hypot(c,e,d);c=c/f*10;e=e/f*10;d=d/f*10;f=Yc(a,3,b.x,b.y+.5,b.z,c,e,d);f.l=b.v;b.u=10;b.D--;b=new fa(13,f.x+.05*c,f.y+.05*e,f.z+.05*d);b.l=f.l;cd(a,b)}}
function hd(a,b,c,e,d){var f=Math.hypot(c,e,d);c/=f;e/=f;d/=f;let h=f,g=null;for(var k=0;k<a.g.s.length;k++){var l=a.g.s[k];if(!(2!==l.A||l.v===b.v||l.v===b.l||0>=l.o)){var p=id(c,e,d,b.x-l.x,b.y-l.y,b.z-l.z,1,f);null!==p&&p<h&&(h=p,g=l)}}for(k=0;k<a.h.l.length;k++)l=a.h.l[k],p=id(c,e,d,b.x-l.x,b.y-l.y,b.z-l.z,.8,f),null!==p&&p<h&&(h=p,g=l);for(k=0;k<a.h.i.length;k++)l=a.h.i[k],p=id(c,e,d,b.x-l.x,b.y-(l.y-4.2),b.z-l.z,.8,f),null!==p&&p<h&&(h=p,g=l);for(f=0;f<h;f+=.1)if(b.y+f*e<n(a.h,b.x+f*c,b.z+f*
d)){h=f;g=ha;break}return g?new Qc(g,h):null}function jd(a,b,c){if(0>=b.o){b.o=0;b.H=xa(a.g)+1;let e=new fa(15,b.x,b.y,b.z);e.v=b.v;e.l=c;cd(a,e)}}function id(a,b,c,e,d,f,h,g){var k=a*a+b*b+c*c;a=2*(a*e+b*d+c*f);d=e*e+d*d+f*f-h*h;if(0>a*a-4*k*d)return null;e=(-1*a+Math.sqrt(Math.pow(a,2)-4*k*d))/(2*k);k=(-1*a-Math.sqrt(Math.pow(a,2)-4*k*d))/(2*k);return 0<=e&&e<g||0<=k&&k<g?Math.min(e,k):0<=e&&e<g?e:0<=k&&k<g?k:null}
function kd(a,b,c){let e=c.x-b.x;c=c.z-b.z;let d=Math.hypot(e,c);b.h=e/d*8/30;b.i=c/d*8/30;b.x+=b.h;b.z+=b.i;b.y=n(a.h,b.x,b.z)+1;b.j=Math.atan2(b.h,b.i)}function ld(a,b,c,e,d,f){let h=null;f=f||a.g.s;for(let k=0;k<f.length;k++){let l=f[k];if(b!==l&&l.A===c&&0<l.o&&(!d||!pa(d,l))){var g=l.x-b.x;let p=l.y-b.y,v=l.z-b.z,ba=Math.hypot(g,v);ba<e&&(g=hd(a,b,g,p,v),g&&g.g!==l||(h=l,e=ba))}}return h}
function Uc(a){for(var b=a?0:1;b<Sc.length;b++){var c;(c=a)||(c=Sc[b],Pc(c.g),c=-3>c.g.currentTime);if(c)return Sc[b]}a=new Xc;a.g.h=Date.now()/1E3+10;Sc.push(a);return a}
setInterval(function(){for(let ba=Sc.length-1;0<ba;ba--){var a=Sc[ba];if(0===a.i.length)Sc.splice(ba,1);else if(Pc(a.g),0<=a.g.currentTime&&!(1>=xa(a.g))){var b=wa(a.h,a.g.currentTime),c=va(a.h,a.g.currentTime);for(let sa=a.g.s.length-1;0<=sa;sa--){var e=a.g.s[sa];if(0>=e.o)continue;let ta=!1;switch(e.A){case 2:0<e.u&&e.u--;if(e.N){var d=a,f=e,h=b,g=c;f.h=f.g=f.i=0;var k=ld(d,f,2,40),l=ld(d,f,6,20,h),p=ld(d,f,4,40,g,d.h.i);pa(h,f)?kd(d,f,g):0===f.u&&k?(kd(d,f,k),gd(d,f,k.x-f.x+.2*Math.random()-.1,
k.y-f.y+.2*Math.random()-.1,k.z-f.z+.2*Math.random()-.1)):l?kd(d,f,l):pa(g,f)?kd(d,f,g):p&&(h=Date.now()/3E3*2*m,kd(d,f,{x:p.x+3*Math.cos(h),z:p.z+3*Math.sin(h)}))}0==a.m%33&&pa(b,e)&&(e.o-=5,jd(a,e));break;case 3:d=a;f=e;k=f.h;l=f.g;var v=f.i;g=Math.hypot(k,l,v);p=k/g;h=l/g;g=v/g;if(k=hd(d,f,k,l,v))switch(l=k.g,v=k.h,l.A){case 2:l.o-=25,jd(d,l,f.l),cd(d,new fa(14,f.x+v*p,f.y+v*h,f.z+v*g))}(d=!!k)&&(ta=!0);e.x+=e.h;e.y+=e.g;e.z+=e.i;if(-500>e.x||500<e.x||-500>e.z||500<e.z)ta=!0;break;case 6:case 7:if(d=
ld(a,e,2,1))6===e.A?d.D+=30:d.o=Math.min(100,d.o+50),e=new fa(16,e.x,e.y,e.z),e.l=d.v,cd(a,e),ta=!0}ta&&a.g.s.splice(sa,1)}a.m++}}},33);
module.exports=function(a){const b=new Tc(a);a.on("update",function(c){if(c&&void 0!==c.x&&void 0!==c.y&&void 0!==c.z){b.g.name=c.name;b.g.j=c.j;b.g.x=c.x;b.g.y=c.y;b.g.z=c.z;b.g.h=c.h;b.g.g=c.g;b.g.i=c.i;if(c.actions)for(let f=0;f<c.actions.length;f++){var e=c.actions[f];switch(e.A){case 8:e=Uc();var d=b;d.h&&Zc(d.h,d);e.i.push(d);d.h=e;d.g=Vc(e,25,25);break;case 9:gd(b.h,b.g,e.h,e.g,e.i)}}Wc(b)}});a.on("disconnect",function(){Zc(b.h,b)});Wc(b)};
